### 慢查询及优化

#### 慢查询

当sql语句执行时间较长时，可以通过日志的方式进行记录，即慢查询日志，用来记录在MySQL中**响应时间超过阀值**的语句。

##### 慢查询日志设置

- 临时开启慢查询日志

  默认情况下`slow_query_log`的值为`OFF`，表示慢查询日志是禁用的，可以通过设置`slow_query_log`的值来开启

  ```sql
  mysql> show variables  like '%slow_query_log%'; -- 默认情况下慢查询日志功能是关闭的
  +---------------------+------------------------------------------------------------+
  | Variable_name       | Value                                                      |
  +---------------------+------------------------------------------------------------+
  | slow_query_log      | OFF                                                        |
  | slow_query_log_file | D:\mysql\mysql-8.0.22-winx64\data\DESKTOP-GKN9MD5-slow.log |
  +---------------------+------------------------------------------------------------+
  2 rows in set, 1 warning (0.21 sec)
  
  mysql> show variables like '%log_output%';  -- 查看慢查询存储方式，默认为file方式
  +---------------+-------+
  | Variable_name | Value |
  +---------------+-------+
  | log_output    | FILE  |
  +---------------+-------+
  1 row in set, 1 warning (0.00 sec)
  
  -- 查看设置慢查询的时间阈值，默认为10s,超过该阈值的语句会被记录在文件中
  mysql> show variables  like '%long_query_time%'; 
  +-----------------+-----------+
  | Variable_name   | Value     |
  +-----------------+-----------+
  | long_query_time | 10.000000 |
  +-----------------+-----------+
  1 row in set, 1 warning (0.00 sec)
  
  -- 该系统变量指定未使用索引的查询是否被记录到慢查询日志中，默认是关闭，调优建议开启
  mysql> show variables like 'log_queries_not_using_indexes';
  +-------------------------------+-------+
  | Variable_name                 | Value |
  +-------------------------------+-------+
  | log_queries_not_using_indexes | OFF   |
  +-------------------------------+-------+
  1 row in set, 1 warning (0.00 sec)
  
  
  set global slow_query_log = on; -- 临时开启慢查询日志
  -- 设置慢查询的存储方式，可以设置为table,如果是table则慢查询信息会保存到mysql库下的slow_log表中
  set global log_output = file; 
  set global long_query_time=4; -- 设置慢查询的时间阈值，根据实际表的情况设置阈值
  set global log_queries_not_using_indexes=on; -- 设置指定未使用索引的查询也被记录到慢查询日志中
  ```

- 永久设置慢查询日志开启，以及设置慢查询日志时间临界点

  在配置文件my.cnf或my.ini中的[mysqld]下面添加设置相关参数，然后重启mysql服务生效。

  ```
  [mysqld]
  slow_query_log = 1
  slow_query_log_file = /tmp/mysql_slow.log
  ...
  ```

##### 慢查询分析

使用慢查询日志分析工具mysqldumpslow

[详细参数查看官方链接](https://dev.mysql.com/doc/refman/8.0/en/mysqldumpslow.html)

显示出慢查询日志中最慢的10条sql：`mysqldumpslow -t 10  /data/mysql/mysql-slow.log` 

#### EXPLAIN

[官方文档链接](https://dev.mysql.com/doc/refman/8.0/en/explain.html)
使用EXPLAIN关键字可以模拟优化器执行SQL语句，分析查询语句或是结构的性能瓶颈。在select语句之前增加explain关键字，MySQL会在查询上设置一个标记，执行查询会返回执行计划的信息，即解释MySQL将如何执行查询，而不是执行SQL。

```
mysql> explain select * from cpu\G
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: cpu
   partitions: NULL
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 12
     filtered: 100.00
        Extra: NULL
1 row in set, 1 warning (0.00 sec)
```

##### explain列字段的含义

[参考1](https://www.cnblogs.com/tufujie/p/9413852.html)

[参考2](https://www.cnblogs.com/xiaoqiang-code/p/11404149.html)

- **id**

  id列的编号是select的序列号，有几个select就有几个id，并且id的顺序是按select出现的顺序增长的。id越大执行优先级越高，id相同则从上往下执行，id为NULL最后执行
  
- **select type**

  select type表示对应行是简单还是复杂的查询。
  simple：简单查询。查询不包含子查询和union
  primary：复杂查询中最外层的select
  subquery：包含在select中的子查询（不在from子句中）
  derived：包含在from子句中的子查询。MySQL会将结果存放在一个临时表中，也称为派生表。
  union：在union关键字随后的selelct。
  
- **table**

  这一列表示explain的一行正在访问哪个表。
  当from子句中有子查询时，table列是格式，表示当前查询依赖id=N的查询，于是先执行id=N的查询。
  当有union时，UNION RESULT的table列的值为<union 1,2>，1和2表示参与union的select行id

- **type**

  这一列表示关联类型或访问类型，即MySQL决定如何查找表中的行，查找数据行对应的大概范围。
  依次从最优到最差的分别为：system>const>eq_ref>ref>range>index>All
  一般来说，得保证查询达到range级别，最好达到ref。
  NULL：MySQL能够在优化阶段分解查询语句，在执行阶段用不着在访问表或索引。例如：在索引列中选取最小值，可以单独查找索引来完成，不需在执行时访问表

  const、system：mysql能对查询的某部分进行优化并将其转换成一个常量（可看成是show warnings的结果）。用于primay key或unique key的所有列与常数比较时，所以表最多有一个匹配行，读取1次，速读较快。system 是const的特例，表中只有一行元素匹配时为system

  eq_ref：primay key或 unique key索引的所有部分被连接使用，最多只会返回一条符合条件的记录。这可能是const之外最好的联接类型，简单的select查询不会出现这种type

id:选择标识符
select_type:表示查询的类型。
table:输出结果集的表
partitions:匹配的分区
type:表示表的连接类型
possible_keys:表示查询时，可能使用的索引
key:表示实际使用的索引
key_len:索引字段的长度
ref:列与索引的比较
rows:扫描出的行数(估算的行数)
filtered:按表条件过滤的行百分比
Extra:执行情况的描述和说明

#### mysql优化

http://www.iamlintao.com/tag/mysql

